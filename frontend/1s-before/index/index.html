<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>채팅방 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .chat-box {
        border: 1px solid #ccc;
        height: 400px;
        margin-bottom: 20px;
        padding: 10px;
        overflow-y: auto;
      }
      .input-group {
        margin-bottom: 10px;
      }
      .input-group input {
        padding: 5px;
        margin-right: 10px;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        border-radius: 5px;
      }
      .user-count {
        background-color: #f0f0f0;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
      }
      .my-message {
        background-color: #e3f2fd;
        margin-left: 20%;
      }
      .other-message {
        background-color: #f5f5f5;
        margin-right: 20%;
      }
      .status-message {
        text-align: center;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>WebSocket 채팅방 테스트</h2>

      <div class="input-group">
        <input type="text" id="roomId" placeholder="채팅방 ID" />
        <input type="text" id="username" placeholder="사용자 이름" />
        <button onclick="connect()">채팅방 입장</button>
        <button onclick="disconnect()">채팅방 나가기</button>
      </div>

      <div class="user-count">현재 채팅방 인원: <span id="userCount">0</span>명</div>

      <div class="chat-box" id="messageArea"></div>

      <div class="input-group">
        <input
          type="text"
          id="message"
          placeholder="메시지를 입력하세요"
          onkeypress="if(event.keyCode==13) sendMessage()" />
        <button onclick="sendMessage()">전송</button>
      </div>
    </div>

    <script>
      let stompClient = null;
      let username = '';
      let currentRoomId = '';

      function connect() {
        username = document.getElementById('username').value.trim();
        currentRoomId = document.getElementById('roomId').value.trim();

        if (!username || !currentRoomId) {
          alert('사용자 이름과 채팅방 ID를 입력해주세요.');
          return;
        }

        // WebSocket 연결
        const socket = new WebSocket('ws://localhost:8080/api/v1/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            console.log('Connected: ' + frame);

            // 채팅 메시지 구독
            stompClient.subscribe('/chat/sub/room/' + currentRoomId, onMessageReceived);

            // 채팅방 인원수 구독
            stompClient.subscribe(
              '/chat/sub/room/' + currentRoomId + '/count',
              onUserCountReceived
            );

            // 채팅방 입장 알림 전송
            stompClient.send(
              '/chat/pub/room/' + currentRoomId + '/enter',
              {},
              JSON.stringify({
                roomId: currentRoomId,
                sender: username,
              })
            );

            addStatusMessage('채팅방에 입장했습니다.');
            document.getElementById('message').focus();
          },
          onError
        );
      }

      function disconnect() {
        if (stompClient) {
          stompClient.send(
            '/chat/pub/room/' + currentRoomId + '/leave',
            {},
            JSON.stringify({
              roomId: currentRoomId,
              sender: username,
            })
          );
          stompClient.disconnect(function () {
            console.log('Disconnected');
          });
          addStatusMessage('채팅방에서 나갔습니다.');

          // 입력 필드 활성화
          document.getElementById('username').disabled = false;
          document.getElementById('roomId').disabled = false;
        }
        stompClient = null;
      }

      function sendMessage() {
        const messageInput = document.getElementById('message');
        const messageContent = messageInput.value.trim();

        if (messageContent && stompClient) {
          const chatMessage = {
            roomId: currentRoomId,
            sender: username,
            content: messageContent,
            sentAt: new Date(),
          };

          stompClient.send(
            '/chat/pub/sendMessage/' + currentRoomId,
            {},
            JSON.stringify(chatMessage)
          );
          messageInput.value = '';
        }
      }

      function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        const messageElement = document.createElement('div');

        if (message.sender === username) {
          messageElement.className = 'message my-message';
        } else {
          messageElement.className = 'message other-message';
        }

        const time = new Date(message.sentAt).toLocaleTimeString();
        messageElement.innerHTML = `<strong>${message.sender}</strong> (${time})<br>${message.content}`;

        const messageArea = document.getElementById('messageArea');
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight;
      }

      function onUserCountReceived(payload) {
        try {
          // payload.body를 JSON 형태로 파싱
          const roomInfo = JSON.parse(payload.body);

          // 파싱된 userCount를 가져옴
          const userCount = roomInfo.userCount;

          if (!isNaN(userCount)) {
            console.log('Updating user count on page:', userCount + '명');
            document.getElementById('userCount').textContent = userCount;
          } else {
            console.error('유효하지 않은 사용자 수가 수신되었습니다:', payload.body);
          }
        } catch (error) {
          console.error('수신된 데이터가 JSON 형식이 아닙니다:', payload.body);
        }
      }

      function addStatusMessage(content) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message status-message';
        messageElement.textContent = content;

        const messageArea = document.getElementById('messageArea');
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight;
      }

      function onError(error) {
        console.error('WebSocket 오류:', error);
        addStatusMessage('연결 중 오류가 발생했습니다. 다시 시도해주세요.');
      }

      // 페이지 종료 시 자동 연결 해제
      window.onbeforeunload = function () {
        disconnect();
      };
    </script>
  </body>
</html>
